<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DMX Portal">
<meta name="theme-color" content="#1a1a2e">
<link rel="manifest" href="/manifest-portal.json">
<link rel="apple-touch-icon" href="/icon-192.png">
<title>DMX Portal</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#111;color:#eee;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px 16px}
#offlineBanner{display:none;position:fixed;top:0;left:0;right:0;background:#c0392b;color:#fff;
  text-align:center;padding:8px;font-size:0.85em;z-index:100}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;
  padding:8px 20px;border-radius:20px;font-size:0.85em;opacity:0;transition:opacity 0.3s;z-index:100}
h1{font-size:1.4em;margin-bottom:4px;color:#0af}
.subtitle{font-size:0.8em;color:#888;margin-bottom:20px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;width:100%;max-width:400px}
.card{display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:#1a1a2e;border-radius:12px;padding:20px 12px;text-decoration:none;color:#eee;
  border:2px solid transparent;transition:border-color 0.2s,transform 0.1s;min-height:130px}
.card:active{transform:scale(0.96)}
.card .icon{font-size:2.2em;margin-bottom:8px}
.card .name{font-size:1em;font-weight:600;margin-bottom:4px}
.card .desc{font-size:0.7em;color:#999;text-align:center;line-height:1.3}
.card:nth-child(1){border-color:#3498db30}.card:nth-child(1):hover{border-color:#3498db}
.card:nth-child(2){border-color:#e74c3c30}.card:nth-child(2):hover{border-color:#e74c3c}
.card:nth-child(3){border-color:#9b59b630}.card:nth-child(3):hover{border-color:#9b59b6}
.card:nth-child(4){border-color:#27ae6030}.card:nth-child(4):hover{border-color:#27ae60}
.card:nth-child(5){border-color:#f39c1230}.card:nth-child(5):hover{border-color:#f39c12}
.card:nth-child(6){border-color:#1abc9c30}.card:nth-child(6):hover{border-color:#1abc9c}
.footer{margin-top:24px;display:flex;flex-direction:column;align-items:center;gap:8px}
.footer a{color:#888;text-decoration:none;font-size:0.8em}
.footer a:hover{color:#0af}
.device-name{font-size:0.75em;color:#555;margin-top:8px}
@media(min-width:600px){.grid{grid-template-columns:repeat(3,1fr);max-width:600px}}
/* Connection Manager */
#connMgr{text-align:center;width:100%;max-width:400px}
#connMgr .spinner{display:inline-block;width:40px;height:40px;border:3px solid #333;
  border-top-color:#0af;border-radius:50%;animation:spin 0.8s linear infinite;margin:20px 0 12px}
@keyframes spin{to{transform:rotate(360deg)}}
#connMgr .status{color:#888;font-size:0.85em;margin-bottom:16px}
#connMgr .manual{margin-top:12px}
#connMgr input[type=text]{background:#222;border:1px solid #444;color:#eee;padding:8px 12px;
  border-radius:6px;font-size:0.9em;width:180px;text-align:center}
#connMgr input[type=text]::placeholder{color:#666}
#connMgr button{background:#0af;color:#111;border:none;padding:8px 16px;border-radius:6px;
  font-size:0.85em;font-weight:600;cursor:pointer;margin-left:6px}
#connMgr button:active{opacity:0.8}
#connMgr .devices{margin-top:12px;font-size:0.8em;color:#666}
#connMgr .dev-item{display:inline-block;background:#1a1a2e;padding:4px 10px;border-radius:12px;
  margin:3px;cursor:pointer;border:1px solid #333;color:#aaa}
#connMgr .dev-item:hover{border-color:#0af;color:#0af}
/* PWA install */
#installBtn{display:none;margin-top:12px;background:#0af;color:#111;border:none;
  padding:10px 20px;border-radius:8px;font-size:0.9em;font-weight:600;cursor:pointer}
#installBtn:active{opacity:0.8}
/* PWA info */
#pwaInfo{margin-top:12px;width:100%;max-width:400px;font-size:0.75em;color:#666;text-align:center}
#pwaInfo summary{cursor:pointer;color:#888;font-size:0.85em;list-style:none;display:flex;align-items:center;justify-content:center;gap:4px}
#pwaInfo summary::-webkit-details-marker{display:none}
#pwaInfo .steps{text-align:left;background:#1a1a2e;border-radius:8px;padding:10px 14px;margin-top:8px;line-height:1.6}
#pwaInfo .steps b{color:#0af}
#pwaInfo .steps code{background:#222;padding:1px 5px;border-radius:3px;font-size:0.95em;color:#f90}
#pwaInfo .shortcut-hint{margin-top:6px;color:#888;font-size:0.95em}
</style>
</head>
<body>
<div id="offlineBanner"></div>
<h1>DMX Konzola</h1>
<p class="subtitle" id="deviceName">Izberi vmesnik</p>

<!-- Connection Manager (prikazan kadar naprava ni dosegljiva) -->
<div id="connMgr" style="display:none">
  <div class="spinner" id="connSpinner"></div>
  <div class="status" id="connStatus">Iskanje naprave...</div>
  <div class="manual" id="connManual" style="display:none">
    <input type="text" id="connIp" placeholder="IP naslov (npr. 192.168.1.50)">
    <button onclick="manualConnect()">Poveži</button>
  </div>
  <div class="devices" id="connDevices"></div>
</div>

<div class="grid" id="personaGrid">
  <a class="card" href="/sound-eng">
    <span class="icon">&#127911;</span>
    <span class="name">Tonski mojster</span>
    <span class="desc">Scene, STL, BPM, skupinski dimmerji</span>
  </a>
  <a class="card" href="/theater">
    <span class="icon">&#127917;</span>
    <span class="name">Gledali&#353;&#269;e</span>
    <span class="desc">GO / BACK, cue list, crossfade</span>
  </a>
  <a class="card" href="/dj">
    <span class="icon">&#127926;</span>
    <span class="name">DJ</span>
    <span class="desc">BPM sync, mood preseti, strobe</span>
  </a>
  <a class="card" href="/staff">
    <span class="icon">&#127860;</span>
    <span class="name">Osebje</span>
    <span class="desc">Enostavni preseti, svetlost</span>
  </a>
  <a class="card" href="/event">
    <span class="icon">&#127882;</span>
    <span class="name">Zabava / poroka</span>
    <span class="desc">Timeline, samodejno napredovanje</span>
  </a>
  <a class="card" href="/busker">
    <span class="icon">&#127928;</span>
    <span class="name">Busker</span>
    <span class="desc">Zvok-reaktivno, 4 looki</span>
  </a>
</div>

<div class="footer">
  <a href="/">&#9881; Polni vmesnik (Pro)</a>
  <button id="installBtn" onclick="pwaInstall()">Namesti aplikacijo</button>
  <span class="device-name" id="deviceInfo"></span>
</div>

<!-- PWA info (prikazano kadar ni secure context) -->
<div id="pwaInfo" style="display:none">
  <details>
    <summary>&#9432; Namesti kot aplikacijo</summary>
    <div class="steps" id="pwaSteps"></div>
  </details>
</div>
<div id="toast"></div>

<script src="/persona-core.js"></script>
<script>
// ===== Connection Manager =====
var STORAGE_KEY = 'dmx_devices';
var DISCOVER_TIMEOUT = 3000;

function getDevices() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
    catch(e) { return []; }
}
function saveDevice(host, hostname) {
    var devs = getDevices();
    // Posodobi ali dodaj
    var found = false;
    for (var i = 0; i < devs.length; i++) {
        if (devs[i].host === host) {
            devs[i].hostname = hostname;
            devs[i].lastSeen = Date.now();
            found = true;
            break;
        }
    }
    if (!found) devs.unshift({host: host, hostname: hostname, lastSeen: Date.now()});
    // Ohrani zadnjih 10
    if (devs.length > 10) devs = devs.slice(0, 10);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(devs));
}

function tryDiscover(host) {
    var ctrl = new AbortController();
    var timer = setTimeout(function() { ctrl.abort(); }, DISCOVER_TIMEOUT);
    return fetch('http://' + host + '/api/discover', {mode:'cors', signal: ctrl.signal})
        .then(function(r) { clearTimeout(timer); return r.json(); })
        .then(function(d) { return {host: host, data: d}; })
        .catch(function() { clearTimeout(timer); return null; });
}

function showConnMgr() {
    document.getElementById('connMgr').style.display = 'block';
    document.getElementById('personaGrid').style.display = 'none';
}
function hideConnMgr() {
    document.getElementById('connMgr').style.display = 'none';
    document.getElementById('personaGrid').style.display = '';
}
function setStatus(msg) {
    document.getElementById('connStatus').textContent = msg;
}
function showManual() {
    document.getElementById('connSpinner').style.display = 'none';
    document.getElementById('connManual').style.display = 'block';
    // Prikaži znane naprave
    var devs = getDevices();
    if (devs.length > 0) {
        var html = 'Zadnje znane naprave: ';
        for (var i = 0; i < devs.length; i++) {
            html += '<span class="dev-item" onclick="tryDevice(\'' + devs[i].host + '\')">' +
                    (devs[i].hostname || devs[i].host) + ' (' + devs[i].host + ')</span>';
        }
        document.getElementById('connDevices').innerHTML = html;
    }
}
function tryDevice(host) {
    document.getElementById('connSpinner').style.display = '';
    document.getElementById('connManual').style.display = 'none';
    setStatus('Povezovanje na ' + host + '...');
    tryDiscover(host).then(function(result) {
        if (result) {
            saveDevice(result.host, result.data.hostname);
            if (result.host !== location.host) {
                location.href = 'http://' + result.host + '/portal';
            } else {
                hideConnMgr();
                PersonaCore.connect();
            }
        } else {
            setStatus('Naprava ' + host + ' ni dosegljiva');
            showManual();
        }
    });
}
function manualConnect() {
    var ip = document.getElementById('connIp').value.trim();
    if (!ip) return;
    // Dodaj port če manjka
    if (ip.indexOf(':') === -1) ip = ip;
    tryDevice(ip);
}

function discoverDevice() {
    // 1. Poskusi trenutni host
    setStatus('Preverjam trenutni naslov...');
    tryDiscover(location.host).then(function(result) {
        if (result) {
            // Trenutni host deluje — shrani in prikaži UI
            saveDevice(result.host, result.data.hostname);
            hideConnMgr();
            PersonaCore.connect();
            return;
        }
        // 2. Poskusi zadnje znane naslove
        var devs = getDevices();
        var hosts = [];
        for (var i = 0; i < devs.length; i++) {
            if (devs[i].host !== location.host) hosts.push(devs[i].host);
        }
        // 3. Poskusi mDNS iz shranjenih hostname-ov
        var mdnsHosts = [];
        for (var i = 0; i < devs.length; i++) {
            if (devs[i].hostname) {
                var mdns = devs[i].hostname.toLowerCase() + '.local';
                if (hosts.indexOf(mdns) === -1) mdnsHosts.push(mdns);
            }
        }
        // Poskusi tudi privzeto
        if (mdnsHosts.indexOf('artnet-node.local') === -1) mdnsHosts.push('artnet-node.local');

        var allHosts = hosts.concat(mdnsHosts);

        if (allHosts.length === 0) {
            setStatus('Naprava ni najdena');
            showManual();
            return;
        }

        setStatus('Iščem na znanih naslovih...');
        var promises = [];
        for (var i = 0; i < allHosts.length; i++) {
            promises.push(tryDiscover(allHosts[i]));
        }
        Promise.all(promises).then(function(results) {
            for (var i = 0; i < results.length; i++) {
                if (results[i]) {
                    saveDevice(results[i].host, results[i].data.hostname);
                    location.href = 'http://' + results[i].host + '/portal';
                    return;
                }
            }
            // Nič ni delovalo
            setStatus('Naprava ni najdena');
            showManual();
        });
    });
}

// ===== PWA Install Prompt =====
var deferredPrompt = null;
function _pwaIsInstalled() {
    return window.matchMedia('(display-mode: standalone)').matches ||
           window.navigator.standalone === true ||
           localStorage.getItem('pwa_installed') === '1';
}
window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    deferredPrompt = e;
    if (_pwaIsInstalled()) return;
    document.getElementById('installBtn').style.display = 'block';
});
window.addEventListener('appinstalled', function() {
    localStorage.setItem('pwa_installed', '1');
    document.getElementById('installBtn').style.display = 'none';
    deferredPrompt = null;
});
function pwaInstall() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(function(r) {
            if (r.outcome === 'accepted') localStorage.setItem('pwa_installed', '1');
            deferredPrompt = null;
        });
        document.getElementById('installBtn').style.display = 'none';
    }
}

// ===== PWA / Secure Context Info =====
(function() {
    var info = document.getElementById('pwaInfo');
    var steps = document.getElementById('pwaSteps');
    if (!info || !steps) return;
    if (window.isSecureContext) {
        // SW deluje — prikaži info samo če ni standalone
        if (!PersonaCore.isStandalone()) {
            info.style.display = 'block';
            steps.innerHTML = '<p class="shortcut-hint">Tapni <b>Namesti aplikacijo</b> zgoraj, ali uporabi meni brskalnika.</p>';
        }
        return;
    }
    // Ni secure context — SW ne bo deloval
    info.style.display = 'block';
    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    var isAndroid = /Android/.test(navigator.userAgent);
    var html = '';
    if (isAndroid) {
        html += '<p><b>Za polno aplikacijo (offline + namestitev):</b></p>' +
            '<p>1. Odpri <code>chrome://flags</code> v Chrome</p>' +
            '<p>2. Poišči <code>insecure origins</code></p>' +
            '<p>3. Dodaj: <code>http://' + location.host + '</code></p>' +
            '<p>4. Tapni <b>Relaunch</b></p>' +
            '<p style="margin-top:8px"><b>Za bližnjico brez offline:</b></p>' +
            '<p>Chrome meni (&#8942;) &rarr; <b>Dodaj na začetni zaslon</b></p>';
    } else if (isIOS) {
        html += '<p><b>Dodaj na začetni zaslon:</b></p>' +
            '<p>Tapni <b>Deli</b> (&#9997;) &rarr; <b>Dodaj na začetni zaslon</b></p>' +
            '<p class="shortcut-hint">Odpre se kot samostojna aplikacija (brez offline načina)</p>';
    } else {
        html += '<p><b>Dodaj med zaznamke</b> za hiter dostop.</p>' +
            '<p class="shortcut-hint">Offline način zahteva HTTPS.</p>';
    }
    steps.innerHTML = html;
})();

// ===== Init =====
// Preveri ali je naprava dosegljiva — če da, pokaži grid; če ne, pokaži connection manager
PersonaCore.onHello(function(d) {
    hideConnMgr();
    if (d.fw) document.getElementById('deviceName').textContent = 'Firmware: ' + d.fw;
    var info = document.getElementById('deviceInfo');
    if (info) info.textContent = location.host;
    // Shrani napravo v localStorage
    saveDevice(location.host, d.hostname || '');
});

// Zaženi discovery — najprej hitro preizkusimo ali je ESP32 dosegljiv
showConnMgr();
discoverDevice();
</script>
</body>
</html>
